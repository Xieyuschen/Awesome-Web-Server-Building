# How configuration file stored in ngx_cycle_t
When it comes to a newer talking about impressions on nginx, there must be a emphasis about it's void pointer. Especially `void****`, coincidentally this type does store the whole configuration file for nginx. Let's make a closer look to it. It's amazing how excellent of nginx author. 
```c
struct ngx_cycle_s {
    void                  ****conf_ctx;
    //etc ...
}
```
In computer science there is no mistory for human design all of them. In [last post](./init-and-read-conf.md) I mentioned nginx create configure memory and then init all modules by calling their init callback. In this page I will read source code and note more details about it.  

## Create Configure memory and init for NGX_CORE_MODULE
Correspond to last post **Step3 and Step5**, this step will allocate memory to store config. Of course all of memory allocate will be managed by `conf_ctx` which is a `void****` type variable. We have already know `create_conf` allocates memory for all `NGX_CORE_MODULE`, so it's time to see how they work.  
As mentioned past, Create config achieved as those code:  
```c
    for (i = 0; cycle->modules[i]; i++) {
        if (cycle->modules[i]->type != NGX_CORE_MODULE) {
            continue;
        }

        module = cycle->modules[i]->ctx;

        if (module->create_conf) {
            rv = module->create_conf(cycle);
            if (rv == NULL) {
                ngx_destroy_pool(pool);
                return NULL;
            }
            cycle->conf_ctx[cycle->modules[i]->index] = rv;
        }
    }
```
Attention to `create_conf`, so where is it defined? For it's a function of module we quickly evoke that there is an interface for each module which may contains definitions of those functions. As expected we found create_conf in `NGX_XXX_MODULE_CTX` struct so pat attention to how they are implemented. 

- Consistence of NGX_CORE_MODULE  
Since now NGX_CORE_MODULE has six specific module part, all of them are official defined. They are showed as following:  
    - `ngx_core_module`
    - `ngx_errlog_module`
    - `ngx_events_module`
    - `ngx_openssl_module`
    - `ngx_http_module`
    - `ngx_mail_module`
And step further, we look at modules array generated by `./configure` in `obj/ngx_modules.c`, we can found not all core modules occupied the first six postion in module array.  
```c
ngx_module_t *ngx_modules[] = {
    &ngx_core_module,
    &ngx_errlog_module,
    &ngx_conf_module,
    &ngx_regex_module,
    &ngx_events_module,
    &ngx_event_core_module,
    &ngx_epoll_module,
    &ngx_http_module,
    //etc... there still many modules in this array, it contains 51 modules as a whole array
    NULL
}
```

First look at how ngx_core_module implement its create_conf function, it has already been defined at `src/core/nginx.c:1042`ï¼Œ in this function implements there is a strange scene, you can see it allocates a pointer named ccf but never put it to some position.  As a `create_conf` file, it's quit not its duty to put it to some question. After `create_conf` finished, the result will be set in certain position based on module's index by this sentence.
```c
    cycle->conf_ctx[cycle->modules[i]->index] = rv;
```
**From now the magic variable conf_ctx with type `void****` start to store config details**. 

### index and ctx_index in ngx_module_t
Index is the index in whole modules array, but `ctx_index` is used to present index in its certain module.  

## Modules except NGX_CORE_MODULE create and initialization
In past post **Step7** we see the code initialized by those code, in this part we will find how `init_module` build and principle behind it.
```c
ngx_int_t
ngx_init_modules(ngx_cycle_t *cycle)
{
    ngx_uint_t  i;

    for (i = 0; cycle->modules[i]; i++) {
        if (cycle->modules[i]->init_module) {
            if (cycle->modules[i]->init_module(cycle) != NGX_OK) {
                return NGX_ERROR;
            }
        }
    }

    return NGX_OK;
}
```

In part above we found that `NGX_CORE_MODULE` has been already initialized, so in this part it's mainly focus on the other part. But in this procedure the code doesn't skip the `NGX_CORE_MODULE` because all core modules' init_module are NULL.  
