# How configuration file stored in ngx_cycle_t
When it comes to a newer talking about impressions on nginx, there must be a emphasis about it's void pointer. Especially `void****`, coincidentally this type does store the whole configuration file for nginx. Let's make a closer look to it. It's amazing how excellent of nginx author. 
```c
struct ngx_cycle_s {
    void                  ****conf_ctx;
    //etc ...
}
```
In computer science there is no mistory for human design all of them. In [last post](./init-and-read-conf.md) I mentioned nginx create configure memory and then init all modules by calling their init callback. In this page I will read source code and note more details about it.  

## 1.Create Configure memory and init for NGX_CORE_MODULE
Correspond to last post **Step3 and Step5**, this step will allocate memory to store config. Of course all of memory allocate will be managed by `conf_ctx` which is a `void****` type variable. We have already know `create_conf` allocates memory for all `NGX_CORE_MODULE`, so it's time to see how they work.  
As mentioned past, Create config achieved as those code:  
```c
    for (i = 0; cycle->modules[i]; i++) {
        if (cycle->modules[i]->type != NGX_CORE_MODULE) {
            continue;
        }

        module = cycle->modules[i]->ctx;

        if (module->create_conf) {
            rv = module->create_conf(cycle);
            if (rv == NULL) {
                ngx_destroy_pool(pool);
                return NULL;
            }
            cycle->conf_ctx[cycle->modules[i]->index] = rv;
        }
    }
```
Attention to `create_conf`, so where is it defined? For it's a function of module we quickly evoke that there is an interface for each module which may contains definitions of those functions. As expected we found create_conf in `NGX_XXX_MODULE_CTX` struct so pat attention to how they are implemented. 

- Consistence of NGX_CORE_MODULE  
Since now NGX_CORE_MODULE has six specific module part, all of them are official defined. They are showed as following:  
    - `ngx_core_module`
    - `ngx_errlog_module`
    - `ngx_events_module`
    - `ngx_openssl_module`
    - `ngx_http_module`
    - `ngx_mail_module`
And step further, we look at modules array generated by `./configure` in `obj/ngx_modules.c`, we can found not all core modules occupied the first six postion in module array.  
```c
ngx_module_t *ngx_modules[] = {
    &ngx_core_module,
    &ngx_errlog_module,
    &ngx_conf_module,
    &ngx_regex_module,
    &ngx_events_module,
    &ngx_event_core_module,
    &ngx_epoll_module,
    &ngx_http_module,
    //etc... there still many modules in this array, it contains 51 modules as a whole array
    NULL
}
```

First look at how ngx_core_module implement its create_conf function, it has already been defined at `src/core/nginx.c:1042`ï¼Œ in this function implements there is a strange scene, you can see it allocates a pointer named ccf but never put it to some position.  As a `create_conf` file, it's quit not its duty to put it to some question. After `create_conf` finished, the result will be set in certain position based on module's index by this sentence.
```c
    cycle->conf_ctx[cycle->modules[i]->index] = rv;
```
**From now the magic variable conf_ctx with type `void****` start to store config details**. 

### 1.1 index and ctx_index in ngx_module_t
Index is the index in whole modules array, but `ctx_index` is used to present index in its certain module.  

## 2.Modules except NGX_CORE_MODULE create and initialization
In past post **Step7** we see the code initialized by those code, in this part we will find how `init_module` build and principle behind it.
```c
ngx_int_t
ngx_init_modules(ngx_cycle_t *cycle)
{
    ngx_uint_t  i;

    for (i = 0; cycle->modules[i]; i++) {
        if (cycle->modules[i]->init_module) {
            if (cycle->modules[i]->init_module(cycle) != NGX_OK) {
                return NGX_ERROR;
            }
        }
    }

    return NGX_OK;
}
```

In part above we found that `NGX_CORE_MODULE` has been already initialized, so in this part it's mainly focus on the other part. But in this procedure the code doesn't skip the `NGX_CORE_MODULE` because all core modules' init_module are NULL.  

## 3.How Each Module Config File looks like?
As further step we find an instance of init_module to see how it initializes the config struct and how config struct looks like. Each module owns its specified config obviously.  
- Firstly we focus on NGX_CORE_MODULE modules' config where `void ****conf_ctx` will store a pointer to it. Let's look at module interface and we found such module stores in conf_ctx directly.  
- How about Non NGX_CORE_MODULE?  
The method to init config is all in module interface struct, so how they are put into ngx_cycle_t and assigned? Look declaration about module interface may help us:
```c
// NGX_HTTP_MODULE
// /src/http/modules/ngx_http_memcached_module.c file, ngx_http_memcached_module
static ngx_http_module_t  ngx_http_memcached_module_ctx = {
    NULL,                                  /* preconfiguration */
    NULL,                                  /* postconfiguration */

    NULL,                                  /* create main configuration */
    NULL,                                  /* init main configuration */

    NULL,                                  /* create server configuration */
    NULL,                                  /* merge server configuration */

    ngx_http_memcached_create_loc_conf,    /* create location configuration */
    ngx_http_memcached_merge_loc_conf      /* merge location configuration */
};

// NGX_EVENT_MODULE
// src/event/modules/ngx_epoll_module.c, ngx_epoll_module_t
static ngx_event_module_t  ngx_epoll_module_ctx = {
    &epoll_name,
    ngx_epoll_create_conf,               /* create configuration */
    ngx_epoll_init_conf,                 /* init configuration */

    {
        ngx_epoll_add_event,             /* add an event */
        ngx_epoll_del_event,             /* delete an event */
        ngx_epoll_add_event,             /* enable an event */
        ngx_epoll_del_event,             /* disable an event */
        ngx_epoll_add_connection,        /* add an connection */
        ngx_epoll_del_connection,        /* delete an connection */
#if (NGX_HAVE_EVENTFD)
        ngx_epoll_notify,                /* trigger a notify */
#else
        NULL,                            /* trigger a notify */
#endif
        ngx_epoll_process_events,        /* process the events */
        ngx_epoll_init,                  /* init the events */
        ngx_epoll_done,                  /* done the events */
    }
};


// HTTP_CORE_MODULE
// src/event/ngx_event.c, ngx_core_module_t
static ngx_core_module_t  ngx_events_module_ctx = {
    ngx_string("events"),
    NULL,
    ngx_event_init_conf
};
```
Wow, what an amazing intelligence! Here different type of module has a different interface type as a result nginx used `void*` to store it for C language hasn't polymorphism. On the contrary C++ using `RTTI`(Runtime Type Information), C use type to refer it. This is polymorphism in C.  


### 3.1 How nginx convert from void* to a type specified module interface?  
Acctually nginx doesn't have such convertion for it use an unified way to archieve it.  
Code showed above may bring some confused to you, so does it to myself. Each module has unified module exposed for outside, which is type `ngx_module_t`, it's define all things about one module, no matter it's core module or not. So the time the module initialized insider is obvios which in `ngx_init_modules` call in function mentioned at topic 2.2.  
Let's make an instance to end this top, look about the formal `ngx_module_t` in memcached:  
```c
ngx_module_t  ngx_http_memcached_module = {
    NGX_MODULE_V1,
    &ngx_http_memcached_module_ctx,        /* module context */
    ngx_http_memcached_commands,           /* module directives */
    NGX_HTTP_MODULE,                       /* module type */
    NULL,                                  /* init master */
    NULL,                                  /* init module */
    NULL,                                  /* init process */
    NULL,                                  /* init thread */
    NULL,                                  /* exit thread */
    NULL,                                  /* exit process */
    NULL,                                  /* exit master */
    NGX_MODULE_V1_PADDING
};
```
### 3.2 How init_module defined in different modules?  
@todo: Add some examples here for no obj folder generated when compile.

### 3.3
@todo: conclude from book, the functions in module interface as type `ngx_module_t` are callback functions which will only be called when the specified event happened.  
### 3.4
@todo: How different module interface are used and the main,srv,loc conf method are called?  

