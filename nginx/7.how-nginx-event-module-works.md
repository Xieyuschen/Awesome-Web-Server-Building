# How nginx event module works
Before this article all of them are tell something about how config file is initialized for the whole nginx framework. Since now we will step the most important work as a web server of nginx and take an eye to it. We will learn about how nginx event module chooses IO multiplexing mothod based on operation system like `epoll`,`select` or `poll`, how nginx module is represented and so on.  
Nginx is a asynchoized event driven web server. As a result the core tasks of event framework are collecting, managing and distributing event which contains network event and timer event. Nothing could be more important than it in nginx.  

## 1. Basic structures in nginx event module
### 1.1 `ngx_event_module`
First we look the interface of nginx event module:  
```c
typedef struct {
    ngx_str_t              *name;

    void                 *(*create_conf)(ngx_cycle_t *cycle);
    char                 *(*init_conf)(ngx_cycle_t *cycle, void *conf);

    ngx_event_actions_t     actions;
} ngx_event_module_t;

```
### 1.2 `ngx_event_actions_t`
Different from other interface we can easily find that there is an action data member which every **event module MUST implement**. The action declaration is:  
```c
typedef struct {
    ngx_int_t  (*add)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);
    ngx_int_t  (*del)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);

    ngx_int_t  (*enable)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);
    ngx_int_t  (*disable)(ngx_event_t *ev, ngx_int_t event, ngx_uint_t flags);

    ngx_int_t  (*add_conn)(ngx_connection_t *c);
    ngx_int_t  (*del_conn)(ngx_connection_t *c, ngx_uint_t flags);

    ngx_int_t  (*notify)(ngx_event_handler_pt handler);

    ngx_int_t  (*process_events)(ngx_cycle_t *cycle, ngx_msec_t timer,
                                 ngx_uint_t flags);

    ngx_int_t  (*init)(ngx_cycle_t *cycle, ngx_msec_t timer);
    void       (*done)(ngx_cycle_t *cycle);
} ngx_event_actions_t;
```
We can easily find that those functions are bridges to operate event module. The arguments of the first four functions receiving all contain type `ngx_event_t` which is the common event in nginx.  

### 1.3 `ngx_evnet_t`
The first question is that what is an event? According to nginx event driven framework, event refers to the moment when socket/file becomes readable/writable or timer expiring evnet. So as an event structure, it must contain following things:  
- where the event comes from. It maybe a socket, a file or a timer  
- flag to specify the detail of event, such as whether it's readable? If it's writable now?  

Points listed above are my interpreting data member. Let's look up the details in source code:  
- ready: whether event is ready to operate  
- instance: whether current event is valid and not expire  
- active: whether the event is active (so what is the definition of active?)
- timeout: check whether this event is timeout  
- deferred_accept: establish tcp connection until the read data packet arrives  
- handler: the callback when this event happendes(so what is the definition of event happening?)  

### 1.4 connection in nginx
There are so many important data member in connection, I only show some important things here. There are two data members which I  didn't understand at first time of reading book. They are reading/writing event corresponding to an event:  
```c
ngx_event_t *read;
ngx_event_t *write;
```
Those two are easily to understand. The system call `epoll` can only know a file descriptor(corresponding to a connection) is writeable/readable, but when it comes to other callstack it knows which connection owns event any more.  

## 2. When events and connections are created?  
All events no matter read events or write events are initialized at `ngx_init_cycle`. @todo: check if it's right and where is it.  
Connections is managed by cycle by two tructs: `connections` and `free_connections`.  